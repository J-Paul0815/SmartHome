/* CubeCell-LoraWan-DS18B20 - TTN V3 Vollständig
 * HTCC-AB01 + DS18B20 + DEINE KEYS + ABP Params!
 * 5 Minuten Intervall
*/

#include "LoRaWan_APP.h"
#include "Arduino.h"

/* OTAA para - DEINE KEYS */
uint8_t devEui[] = { 0x70, 0xB3, 0xD1, 0x7E, 0xD0, 0x07, 0x4C, 0xD1 };
uint8_t appEui[] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
uint8_t appKey[] = { 0x83, 0xEA, 0xB1, 0xC2, 0x2D, 0x1D, 0xB8, 0x52, 0x50, 0x14, 0x38, 0x11, 0xFA, 0x70, 0x6F, 0xAA };

/* ABP para - WICHTIG FÜR COMPILER! */
uint8_t nwkSKey[] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
uint8_t appSKey[] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
uint32_t devAddr = (uint32_t)0x007e6ae1;

uint16_t userChannelsMask[6] = { 0x00FF,0x0000,0x0000,0x0000,0x0000,0x0000 };
LoRaMacRegion_t loraWanRegion = ACTIVE_REGION;
DeviceClass_t loraWanClass = LORAWAN_CLASS;
uint32_t appTxDutyCycle = 5 * 60 * 1000;        // 5 Minuten
bool overTheAirActivation = LORAWAN_NETMODE;    // OTAA
bool loraWanAdr = LORAWAN_ADR;
bool keepNet = LORAWAN_NET_RESERVE;
bool isTxConfirmed = LORAWAN_UPLINKMODE;
uint8_t appPort = 2;
uint8_t confirmedNbTrials = 4;

/* DS18B20 */
#include <OneWire.h>
#include <DallasTemperature.h>
#define ONE_WIRE_BUS ((uint8_t)GPIO5)
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensors(&oneWire);

static void prepareTxFrame(uint8_t port) {
    pinMode(Vext, OUTPUT);
    digitalWrite(Vext, LOW);
    delay(10);

    uint16_t batteryVoltage = getBatteryVoltage();
    sensors.requestTemperatures();
    float DStemp = sensors.getTempCByIndex(0);
    
    Serial.print("Temperature: ");
    Serial.print(DStemp);
    Serial.print("°C | Battery: ");
    Serial.print(batteryVoltage/1000.0);
    Serial.println("V");
    
    int tmp = ((int)(DStemp * 100)) + 5000;
    appDataSize = 4;
    appData[0] = (uint8_t)(batteryVoltage >> 8);
    appData[1] = (uint8_t)batteryVoltage;
    appData[2] = (uint8_t)(tmp >> 8);
    appData[3] = (uint8_t)tmp;
    
    digitalWrite(Vext, HIGH);
    delay(10);
}

void setup() {
    Serial.begin(115200);
    sensors.begin();
    
#if(AT_SUPPORT)
    enableAt();
#endif
    deviceState = DEVICE_STATE_INIT;
    LoRaWAN.ifskipjoin();
}

void loop() {
    switch(deviceState) {
        case DEVICE_STATE_INIT:
        {
#if(LORAWAN_DEVEUI_AUTO)
            LoRaWAN.generateDeveuiByChipID();
#endif
#if(AT_SUPPORT)
            getDevParam();
#endif
            printDevParam();
            LoRaWAN.init(loraWanClass, loraWanRegion);
            deviceState = DEVICE_STATE_JOIN;
            break;
        }
        case DEVICE_STATE_JOIN:
        {
            LoRaWAN.join();
            break;
        }
        case DEVICE_STATE_SEND:
        {
            prepareTxFrame(appPort);
            LoRaWAN.send();
            deviceState = DEVICE_STATE_CYCLE;
            break;
        }
        case DEVICE_STATE_CYCLE:
        {
            txDutyCycleTime = appTxDutyCycle + randr(0, APP_TX_DUTYCYCLE_RND);
            LoRaWAN.cycle(txDutyCycleTime);
            deviceState = DEVICE_STATE_SLEEP;
            break;
        }
        case DEVICE_STATE_SLEEP:
        {
            LoRaWAN.sleep();
            break;
        }
        default:
        {
            deviceState = DEVICE_STATE_INIT;
            break;
        }
    }
}
